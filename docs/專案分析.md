# CoolPC MCP Server 專案分析

**最後更新**: 2025-12-05 11:35 台北時區

---

## 📋 目錄

1. [專案概述](#專案概述)
2. [技術架構](#技術架構)
3. [核心組件分析](#核心組件分析)
4. [資料流程](#資料流程)
5. [功能特色](#功能特色)
6. [技術亮點](#技術亮點)
7. [潛在改進方向](#潛在改進方向)

---

## 專案概述

### 專案背景

CoolPC MCP Server 是一個整合了資料爬蟲與 AI 查詢服務的專案，主要目標是：

1. **資料來源**: 台灣原價屋 (CoolPC) 線上估價系統 (https://www.coolpc.com.tw/evaluate.php)
2. **目標用戶**: 使用 Claude Desktop 的電腦組裝玩家、系統整合商、一般消費者
3. **核心價值**: 透過 AI 助理快速查詢電腦零組件價格與規格，協助電腦配置決策

### 專案規模

- **程式碼行數**:
  - Python 解析器: ~680 行
  - TypeScript MCP Server: ~1,124 行
  - 總計: ~1,800 行

- **產品資料規模**:
  - 產品分類: 30 個主要分類
  - 產品數量: 數千個產品 (依網站更新而變動)
  - 資料檔案大小: ~4.5 MB (product-sample.json)

- **MCP 工具數量**: 9 個專業查詢工具

---

## 技術架構

### 整體架構圖

```
┌─────────────────────────────────────────────────────────────┐
│                       使用者                                 │
│                    (Claude Desktop)                          │
└───────────────────────┬─────────────────────────────────────┘
                        │ MCP Protocol
                        ↓
┌─────────────────────────────────────────────────────────────┐
│                  MCP Server (TypeScript)                     │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  9 個查詢工具                                         │   │
│  │  - search_products                                   │   │
│  │  - search_cpu / search_gpu                           │   │
│  │  - search_ram / search_ssd                           │   │
│  │  - search_motherboard                                │   │
│  │  - get_product_by_model                              │   │
│  │  - list_categories                                   │   │
│  │  - get_category_products                             │   │
│  └──────────────────────────────────────────────────────┘   │
│                        ↓                                     │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  產品資料載入與查詢引擎                               │   │
│  │  - JSON 資料解析                                     │   │
│  │  - 關鍵字搜尋                                        │   │
│  │  - 規格篩選                                          │   │
│  │  - 價格排序                                          │   │
│  └──────────────────────────────────────────────────────┘   │
└───────────────────────┬─────────────────────────────────────┘
                        │ 讀取 product.json
                        ↓
┌─────────────────────────────────────────────────────────────┐
│                  產品資料庫 (JSON)                            │
│  - 30 個產品分類                                             │
│  - 數千個產品資料                                            │
│  - 品牌、型號、規格、價格、折扣資訊                          │
└───────────────────────┬─────────────────────────────────────┘
                        ↑ 定期更新
┌─────────────────────────────────────────────────────────────┐
│              HTML 解析器 (Python)                             │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  網路爬蟲                                             │   │
│  │  - urllib 下載 HTML                                  │   │
│  │  - BIG5 → UTF-8 編碼轉換                             │   │
│  └──────────────────────────────────────────────────────┘   │
│                        ↓                                     │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  HTML 解析引擎                                        │   │
│  │  - 正則表達式提取 SELECT/OPTION                       │   │
│  │  - 品牌與型號識別                                     │   │
│  │  - 規格與價格提取                                     │   │
│  │  - 特殊標記辨識 (熱賣/降價/限時)                      │   │
│  └──────────────────────────────────────────────────────┘   │
│                        ↓                                     │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  資料結構化與匯出                                     │   │
│  │  - JSON 格式化                                       │   │
│  │  - CSV 匯出 (選用)                                   │   │
│  └──────────────────────────────────────────────────────┘   │
└───────────────────────┬─────────────────────────────────────┘
                        ↓ HTTP GET
┌─────────────────────────────────────────────────────────────┐
│            原價屋網站 (coolpc.com.tw)                         │
│            HTML 產品報價頁面                                  │
└─────────────────────────────────────────────────────────────┘
```

### 技術選型分析

| 技術選項 | 選擇 | 理由 |
|---------|------|------|
| **HTML 解析** | 正則表達式 | 網站 HTML 結構簡單且固定，正則表達式效能最佳 |
| **資料格式** | JSON | 與 MCP Server 整合容易，JavaScript 原生支援 |
| **MCP Server 語言** | TypeScript | 型別安全、與 MCP SDK 整合良好 |
| **爬蟲語言** | Python | 豐富的文字處理函式庫、開發快速 |
| **通訊協定** | MCP (stdio) | Claude Desktop 標準協定，整合簡單 |

---

## 核心組件分析

### 1. HTML 解析器 (coolpc_parser.py)

#### 主要功能模組

```python
class WorkingCoolPCParser:
    """原價屋商品報價解析器"""

    # 核心方法
    def download_html()      # 網路下載 HTML
    def parse_html()         # 解析 HTML 主流程
    def _parse_category()    # 解析單一分類
    def _parse_product()     # 解析單一產品
    def _extract_brand_model()  # 提取品牌型號
    def _extract_specs()     # 提取規格資訊
    def _extract_markers()   # 提取特殊標記
    def _extract_discount()  # 提取折扣資訊
    def export_to_json()     # 匯出 JSON
    def export_to_csv()      # 匯出 CSV
```

#### 關鍵技術點

1. **編碼處理**:
   - 原價屋網站使用 BIG5 編碼
   - 下載後轉換為 UTF-8
   - 使用 `errors='ignore'` 處理無法解碼的字元

2. **HTML 解析策略**:
   - 使用正則表達式提取 `<SELECT>` 和 `<OPTION>` 標籤
   - 每個 `<SELECT>` 對應一個產品分類
   - `<OPTGROUP>` 對應子分類
   - `<OPTION>` 對應個別產品

3. **品牌與型號識別**:
   - **模式 1**: 中英文品牌 (例: "威剛 ADATA")
   - **模式 2**: 純英文品牌 (例: "AMD", "Intel")
   - **CPU 特殊處理**: 識別 "AMD R7 7800X3D"、"Intel i5-14400F" 等格式
   - **型號提取**: 使用正則表達式配對產品編號

4. **規格提取**:
   - 從產品文字中提取 `/` 分隔的規格項
   - 識別容量 (GB/TB)、頻率 (MHz)、核心數等

5. **特殊標記識別**:
   - `◆`: 有討論區文章
   - `★`: 有產品圖片
   - CSS class `r`: 熱賣商品
   - CSS class `g`: 價格異動
   - `↘`: 降價標記
   - `限時`、`下殺`: 限時優惠

#### 資料結構

```python
# 產品結構
{
    'index': str,              # 產品索引
    'group': str,              # 群組名稱
    'brand': str,              # 品牌
    'model': str,              # 型號
    'specs': List[str],        # 規格清單
    'price': int,              # 價格
    'original_price': int,     # 原價 (有折扣時)
    'discount_amount': int,    # 折扣金額
    'markers': List[str],      # 特殊標記
    'raw_text': str            # 原始文字
}

# 分類結構
{
    'category_id': str,        # 分類 ID
    'category_name': str,      # 分類名稱
    'summary': str,            # 摘要資訊
    'stats': {                 # 統計數據
        'total_items': int,
        'hot_items': int,
        'with_images': int,
        'with_discussions': int,
        'price_changes': int,
        'time_limited': int
    },
    'subcategories': [         # 子分類清單
        {
            'name': str,
            'products': List[Product]
        }
    ]
}
```

### 2. MCP Server (src/index.ts)

#### 主要類別與方法

```typescript
class CoolPCMCPServer {
  private server: Server;
  private productData: ProductCategory[];

  // 核心方法
  loadProductData()           // 載入產品資料
  setupHandlers()             // 設定請求處理器

  // 查詢工具
  searchProducts()            // 通用搜尋
  searchCPU()                 // CPU 專用搜尋
  searchGPU()                 // GPU 專用搜尋
  searchRAM()                 // RAM 專用搜尋
  searchSSD()                 // SSD 專用搜尋
  searchMotherboard()         // 主機板專用搜尋
  searchCase()                // 機殼專用搜尋
  getProductByModel()         // 依型號查詢
  listCategories()            // 列出分類
  getCategoryProducts()       // 取得分類產品
}
```

#### MCP 工具設計

每個工具都包含：

1. **工具名稱**: 清晰的功能描述
2. **inputSchema**: JSON Schema 定義參數
3. **description**: 詳細的使用說明與範例

範例 - CPU 搜尋工具:

```typescript
{
  name: "search_cpu",
  description: "Specialized CPU/processor search tool...",
  inputSchema: {
    type: "object",
    properties: {
      socket: {
        type: "string",
        description: "CPU socket type for motherboard compatibility..."
      },
      cores: {
        type: "number",
        description: "Number of physical CPU cores..."
      },
      sort_by: {
        type: "string",
        enum: ["price_asc", "price_desc"]
      },
      limit: {
        type: "number",
        description: "Maximum results to return..."
      }
    }
  }
}
```

#### 查詢演算法

1. **關鍵字搜尋**:
   - 將搜尋文字轉小寫進行比對
   - 搜尋範圍: 品牌、型號、規格、原始文字
   - 支援部分匹配

2. **規格篩選**:
   - CPU: 腳位 (socket)、核心數 (cores)
   - GPU: 晶片型號 (chipset)、顯示記憶體 (memory)
   - RAM: 類型 (DDR4/DDR5)、容量、頻率
   - SSD: 介面類型、容量
   - 主機板: 腳位、晶片組、尺寸
   - 機殼: 主機板尺寸 (form_factor)、側板類型 (side_panel)、是否含電源 (has_psu)、品牌

3. **價格排序**:
   - `price_asc`: 由低至高
   - `price_desc`: 由高至低

4. **結果限制**:
   - 預設回傳 10 筆結果
   - 可自訂上限 (最多 100 筆)

#### 回應格式

```json
{
  "total_found": 45,
  "showing": 10,
  "filters": {
    "socket": "AM5",
    "cores": "any",
    "sort_by": "price_asc"
  },
  "results": [
    {
      "brand": "AMD",
      "model": "R5 7600",
      "specs": ["6核12緒", "3.8GHz", "AM5"],
      "price": 6490,
      "original_price": null,
      "discount_amount": null,
      "subcategory": "AMD Zen4 Ryzen 7000 系列",
      "markers": ["hot"]
    }
  ]
}
```

---

## 資料流程

### 完整工作流程

```
1. 資料更新階段
   ┌─────────────────────────────────────────┐
   │ python3 coolpc_parser.py --download     │
   │         --json product.json             │
   └──────────────┬──────────────────────────┘
                  ↓
   ┌─────────────────────────────────────────┐
   │ 從原價屋網站下載 HTML (BIG5)             │
   └──────────────┬──────────────────────────┘
                  ↓
   ┌─────────────────────────────────────────┐
   │ 編碼轉換 BIG5 → UTF-8                    │
   └──────────────┬──────────────────────────┘
                  ↓
   ┌─────────────────────────────────────────┐
   │ 正則表達式解析 HTML                      │
   │ - 提取 SELECT/OPTION                    │
   │ - 解析品牌型號                          │
   │ - 提取規格價格                          │
   └──────────────┬──────────────────────────┘
                  ↓
   ┌─────────────────────────────────────────┐
   │ 輸出結構化 JSON                          │
   │ product.json (4.5 MB)                   │
   └─────────────────────────────────────────┘

2. MCP Server 啟動階段
   ┌─────────────────────────────────────────┐
   │ npm run build                           │
   │ node build/index.js                     │
   └──────────────┬──────────────────────────┘
                  ↓
   ┌─────────────────────────────────────────┐
   │ 載入 product.json 到記憶體               │
   │ (一次性載入，常駐記憶體)                 │
   └──────────────┬──────────────────────────┘
                  ↓
   ┌─────────────────────────────────────────┐
   │ 註冊 9 個 MCP 工具                       │
   │ 監聽 stdio 通訊                          │
   └─────────────────────────────────────────┘

3. 使用者查詢階段
   ┌─────────────────────────────────────────┐
   │ Claude Desktop 使用者輸入查詢            │
   │ "查詢 AM5 腳位的 CPU"                    │
   └──────────────┬──────────────────────────┘
                  ↓ MCP Protocol (stdio)
   ┌─────────────────────────────────────────┐
   │ MCP Server 接收工具呼叫請求              │
   │ Tool: search_cpu                        │
   │ Args: { socket: "AM5" }                 │
   └──────────────┬──────────────────────────┘
                  ↓
   ┌─────────────────────────────────────────┐
   │ 執行查詢邏輯                             │
   │ 1. 篩選 CPU 分類                        │
   │ 2. 過濾 AM5 腳位                        │
   │ 3. 排序與限制結果                       │
   └──────────────┬──────────────────────────┘
                  ↓
   ┌─────────────────────────────────────────┐
   │ 格式化 JSON 回應                         │
   │ { total_found, showing, results }       │
   └──────────────┬──────────────────────────┘
                  ↓ MCP Protocol (stdio)
   ┌─────────────────────────────────────────┐
   │ Claude Desktop 接收結果                  │
   │ 呈現給使用者                             │
   └─────────────────────────────────────────┘
```

---

## 功能特色

### 1. 智能搜尋功能

#### 通用搜尋 (search_products)
- 支援關鍵字模糊搜尋
- 跨所有產品分類搜尋
- 價格範圍篩選
- 適合不確定產品類型的查詢

#### 專業搜尋工具
- **CPU 搜尋**: 腳位相容性、核心數、價格排序
- **GPU 搜尋**: 晶片型號、顯示記憶體容量
- **RAM 搜尋**: DDR 世代、容量、頻率
- **SSD 搜尋**: 介面類型 (M.2/NVMe/SATA)、容量
- **主機板搜尋**: CPU 腳位、晶片組、尺寸規格

### 2. 資料豐富度

#### 產品資訊
- ✅ 品牌與型號
- ✅ 詳細規格清單
- ✅ 當前價格
- ✅ 原價與折扣金額
- ✅ 特殊標記 (熱賣/降價/限時/討論/圖片)

#### 分類統計
- ✅ 各分類產品總數
- ✅ 熱賣商品數量
- ✅ 價格異動商品數量
- ✅ 限時優惠數量

### 3. 使用者體驗

#### 自然語言查詢
透過 Claude AI，使用者可用自然語言查詢：
- "幫我找 AM5 腳位的 CPU，價格由低到高"
- "查詢 RTX 4060 顯示卡"
- "推薦 32GB DDR5 記憶體"

#### 智能建議
Claude AI 可根據查詢結果：
- 提供配置建議
- 比較不同產品
- 計算總價
- 檢查相容性

---

## 技術亮點

### 1. 高效的 HTML 解析

**挑戰**: 原價屋 HTML 結構複雜，包含大量產品資料

**解決方案**:
- 使用正則表達式直接提取關鍵資訊
- 避免載入完整 DOM 樹（相比 BeautifulSoup 更快）
- 平均解析時間: < 5 秒

### 2. 智能品牌型號識別

**挑戰**: 產品名稱格式不統一

**解決方案**:
```python
# 處理多種格式
# 1. 中英文品牌: "威剛 ADATA LEGEND 900"
# 2. 純英文: "AMD R7 7800X3D"
# 3. CPU 特殊格式: "Intel i5-14400F"
# 4. 促銷標記: "[精選78X3D] AMD R7..."

def _extract_brand_model(text):
    # 多層級正則匹配
    # 1. 移除促銷標記
    # 2. 識別中英文品牌
    # 3. 提取型號
    # 4. 處理 CPU 特殊格式
```

### 3. 顯示卡優先排序

**挑戰**: 顯示卡產品混雜配件，主流產品需優先呈現

**解決方案**:
```python
def _prioritize_vga_products(products):
    # RTX 50 系列: 優先級 1000+
    # RTX 40 系列: 優先級 800+
    # AMD RX 9000/7000: 優先級 700-900
    # 配件: 優先級 -2000
    # 熱賣商品: 加 50 分
```

### 4. MCP 工具設計

**優勢**:
- 清晰的工具分類（通用 vs 專業）
- 詳細的參數說明與範例
- 統一的回應格式
- 支援彈性的查詢參數

---

## 潛在改進方向

### 1. 效能優化

#### 資料索引
**現狀**: 線性搜尋所有產品
**改進**: 建立品牌、型號、規格索引

```typescript
// 範例：建立品牌索引
interface ProductIndex {
  byBrand: Map<string, ProductSpec[]>;
  byModel: Map<string, ProductSpec>;
  byCategory: Map<string, ProductSpec[]>;
}
```

**預期效果**: 查詢速度提升 5-10 倍

#### 增量更新
**現狀**: 每次完整下載解析
**改進**: 比對差異只更新變動部分

### 2. 資料品質提升

#### 規格標準化
**現狀**: 規格格式不一致
**改進**: 建立規格標準化引擎

```python
# 範例：容量標準化
"1TB" → 1000 (GB)
"1000GB" → 1000 (GB)
"2T" → 2000 (GB)
```

#### 相容性資料庫
**現狀**: 無相容性檢查
**改進**: 建立零組件相容性規則庫

```typescript
interface CompatibilityRule {
  cpuSocket: string;         // "AM5"
  compatibleChipsets: string[]; // ["B650", "X670"]
  memoryType: string;        // "DDR5"
}
```

### 3. 功能擴充

#### 價格歷史追蹤
- 記錄每日價格變動
- 繪製價格趨勢圖
- 價格警示通知

#### 比較工具
```typescript
// 新增工具
compare_products({
  models: ["RTX 4060", "RTX 4070"],
  aspects: ["price", "performance", "power"]
})
```

#### 配置驗證
```typescript
// 新增工具
validate_build({
  cpu: "AMD R7 7800X3D",
  motherboard: "B650M",
  ram: "DDR5 32GB"
})
// 檢查腳位、晶片組、記憶體相容性
```

### 4. 可靠性提升

#### 錯誤處理增強
```python
# 網路錯誤重試
@retry(max_attempts=3, backoff=2.0)
def download_html():
    pass

# 解析錯誤記錄
if parse_error:
    log_error(product_id, error_details)
```

#### 資料驗證
```python
def validate_product(product):
    assert product['price'] > 0
    assert product['brand'] is not None
    assert len(product['specs']) > 0
```

### 5. 開發體驗改善

#### 單元測試
```typescript
describe('searchCPU', () => {
  it('should filter by socket', () => {
    const results = server.searchCPU({ socket: 'AM5' });
    expect(results.every(p => p.subcategory.includes('AM5'))).toBe(true);
  });
});
```

#### 型別定義強化
```typescript
// 更嚴格的型別定義
type CPUSocket = 'AM5' | 'AM4' | '1700' | '1851';
type DDRType = 'DDR4' | 'DDR5';
type FormFactor = 'ATX' | 'mATX' | 'ITX';
```

---

## 總結

### 專案優勢

1. **簡潔高效**: 不到 2000 行程式碼實現完整功能
2. **易於維護**: 清晰的模組劃分，註釋完整
3. **使用者友善**: 透過 Claude AI 提供自然語言查詢
4. **資料豐富**: 涵蓋 30 個產品分類，數千個產品
5. **即時更新**: 可隨時從原價屋網站更新最新資料

### 適用場景

- ✅ 電腦 DIY 玩家查詢零組件價格
- ✅ 系統整合商快速比價與配置
- ✅ 一般消費者了解市場行情
- ✅ 電腦教學與諮詢
- ✅ 價格追蹤與分析

### 限制與注意事項

- ⚠️ 資料來源依賴原價屋網站，HTML 結構變動需調整解析器
- ⚠️ 價格僅供參考，實際以原價屋官網為準
- ⚠️ MCP Server 需常駐記憶體（約佔用 50-100 MB）
- ⚠️ 建議每日更新產品資料以保持價格準確性

---

**文件版本**: 1.0
**撰寫日期**: 2025-12-05
**維護者**: Claude Code
